<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Container Wholesale Invoices</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      display: flex;
    }
    
    .sidebar {
      width: 250px;
      background-color: #001937;
      color: white;
      height: 100vh;
      position: fixed;
      overflow-y: auto;
    }
    
    .logo-container {
      padding: 10px 15px;
      text-align: center;
      border-bottom: 1px solid #34495e;
      background-color: #001937;
    }
    
    .logo-container img {
      max-width: 85%;
      height: auto;
    }
    
    .platform-header {
      color: white;
      text-align: center;
      font-size: 14px;
      font-weight: normal;
      margin-top: 10px;
      padding-bottom: 8px;
      white-space: nowrap;
    }
    
    .sidebar-header {
      padding: 20px;
      text-align: center;
      border-bottom: 1px solid #34495e;
      display: none; /* Hide the old header */
    }
    
    .sidebar-menu {
      padding: 0;
      list-style: none;
    }
    
    .sidebar-menu li {
      padding: 0;
    }
    
    .sidebar-menu a {
      display: block;
      padding: 15px 20px;
      color: white;
      text-decoration: none;
      border-bottom: 1px solid #34495e;
      transition: background-color 0.3s;
      font-size: 12.8px; /* Reduced by 20% from standard 16px */
    }
    
    .sidebar-menu a:hover, .sidebar-menu a.active {
      background-color: #34495e;
    }
    
    .sidebar-menu-icon {
      margin-right: 8px; /* Reduced by 20% from 10px */
      font-size: 12.8px; /* Reduced by 20% from standard 16px */
    }
    
    .main-content {
      margin-left: 250px;
      padding: 20px;
      width: calc(100% - 250px);
    }
    h1, h2 {
      margin: 0 0 20px 0;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .filter-bar select, .filter-bar input {
      padding: 8px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .filter-bar button {
      padding: 8px 15px;
      background-color: #3a7bd5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead {
      background-color: #f5f5f5;
    }
    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    .status-pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending {
      background-color: #ffeeba;
      color: #856404;
    }
    .status-paid {
      background-color: #d4edda;
      color: #155724;
    }
    .status-overdue {
      background-color: #f8d7da;
      color: #721c24;
    }
    .status-cancelled {
      background-color: #e2e3e5;
      color: #383d41;
    }
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .btn {
      padding: 6px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background-color: #3a7bd5;
      color: white;
    }
    .btn-success {
      background-color: #28a745;
      color: white;
    }
    .btn-danger {
      background-color: #dc3545;
      color: white;
    }
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .summary-card h3 {
      margin-top: 0;
      color: #666;
      font-size: 14px;
    }
    .summary-card p {
      margin: 0;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    .summary-card.total {
      background-color: #e8f4fd;
    }
    .summary-card.pending {
      background-color: #fff8e6;
    }
    .summary-card.paid {
      background-color: #e8f6ee;
    }
    .summary-card.overdue {
      background-color: #feecef;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 8px;
      max-width: 500px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    .close {
      float: right;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .invoice-details h2 {
      margin-top: 0;
    }
    .invoice-items {
      margin-top: 20px;
    }
    .invoice-total {
      text-align: right;
      margin-top: 20px;
      font-weight: bold;
    }
    .payment-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }
    #loading-spinner {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.7);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3a7bd5;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
    .pagination button {
      padding: 6px 12px;
      margin: 0 5px;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
    }
    .pagination button.active {
      background-color: #3a7bd5;
      color: white;
      border-color: #3a7bd5;
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }
    .empty-state img {
      max-width: 200px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo-container">
      <img src="/images/logos/GCE-logo.png" alt="Global Container Exchange" />
      <div class="platform-header">Container Wholesale Platform</div>
    </div>
    <div class="sidebar-header">
      <h2>Container Wholesale</h2>
    </div>
    
    <ul class="sidebar-menu">
      <li><a href="index.html"><span class="sidebar-menu-icon">üìä</span>Dashboard</a></li>
      <li>
        <a href="#" id="containers-link"><span class="sidebar-menu-icon">üì¶</span>Containers</a>
        <ul class="submenu" style="list-style: none; padding-left: 20px; display: none;">
          <li><a href="view-containers.html" id="view-containers-link" style="font-size: 12px;"><span class="sidebar-menu-icon">üìã</span>View Containers</a></li>
          <li><a href="#" id="add-container-link" style="font-size: 12px;"><span class="sidebar-menu-icon">‚ûï</span>Add Container</a></li>
        </ul>
      </li>
      <li><a href="contracts.html"><span class="sidebar-menu-icon">üìù</span>Contracts</a></li>
      <li><a href="calendar.html"><span class="sidebar-menu-icon">üìÖ</span>Calendar</a></li>
      <li><a href="invoices.html" class="active"><span class="sidebar-menu-icon">üí∞</span>Invoices</a></li>
      <li><a href="email.html"><span class="sidebar-menu-icon">‚úâÔ∏è</span>Messages</a></li>
      <li><a href="organization.html"><span class="sidebar-menu-icon">‚öôÔ∏è</span>Settings</a></li>
      <li class="has-submenu">
        <a href="#" id="platforms-link"><span class="sidebar-menu-icon">üîÑ</span>Platforms</a>
        <ul class="submenu" style="list-style: none; padding-left: 20px; display: none;">
          <li><a href="/container-wholesale/public/index.html" style="font-size: 12px;"><span class="sidebar-menu-icon">üè¢</span>Wholesale Platform</a></li>
          <li><a href="/container-leasing/public/index.html" style="font-size: 12px;"><span class="sidebar-menu-icon">üö¢</span>Leasing Manager</a></li>
        </ul>
      </li>
    </ul>
  </div>

  <div class="main-content">
    <header>
      <img src="images/container-terminal-banner.jpg" alt="Container Wholesale Platform" style="width: 100%; max-width: 1200px; height: 180px; object-fit: cover; object-position: center 40%; margin: 15px 0 5px 0; box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2); border-radius: 4px;">
      <h1 style="font-size: 21.25px; color: #001937; text-align: left; margin-top: 10px; margin-bottom: 10px;">Invoice Management</h1>
    </header>
    <div class="summary-cards">
      <div class="summary-card total">
        <h3>Total Invoices</h3>
        <p id="total-invoices-count">0</p>
      </div>
      <div class="summary-card paid">
        <h3>Paid</h3>
        <p id="paid-invoices-count">0</p>
      </div>
      <div class="summary-card pending">
        <h3>Pending</h3>
        <p id="pending-invoices-count">0</p>
      </div>
      <div class="summary-card overdue">
        <h3>Overdue</h3>
        <p id="overdue-invoices-count">0</p>
      </div>
      <div class="summary-card">
        <h3>Total Amount</h3>
        <p id="total-amount">$0.00</p>
      </div>
    </div>

    <div class="card">
      <div class="filter-bar">
        <select id="status-filter">
          <option value="">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="paid">Paid</option>
          <option value="overdue">Overdue</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <select id="container-filter">
          <option value="">All Containers</option>
        </select>
        <input type="date" id="date-from" placeholder="Date From">
        <input type="date" id="date-to" placeholder="Date To">
        <button id="filter-button">Apply Filters</button>
      </div>

      <table id="invoices-table">
        <thead>
          <tr>
            <th>Invoice #</th>
            <th>Container</th>
            <th>Date</th>
            <th>Due Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="invoices-list">
          <!-- Invoices will be populated here -->
        </tbody>
      </table>
      
      <div id="empty-state" class="empty-state" style="display: none;">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'%3E%3Cpath fill='%23cccccc' d='M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z'/%3E%3Cpath fill='%23cccccc' d='M14 17H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z'/%3E%3C/svg%3E" alt="No invoices">
        <h3>No invoices found</h3>
        <p>Try adjusting your filters or check back later</p>
      </div>

      <div class="pagination" id="pagination">
        <!-- Pagination buttons will be added here -->
      </div>
    </div>
  </div>

  <div id="invoice-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="invoice-details">
        <h2>Invoice #<span id="modal-invoice-number"></span></h2>
        <p><strong>Container:</strong> <span id="modal-container-id"></span></p>
        <p><strong>Date:</strong> <span id="modal-invoice-date"></span></p>
        <p><strong>Due Date:</strong> <span id="modal-due-date"></span></p>
        <p><strong>Status:</strong> <span id="modal-status"></span></p>
        
        <div class="invoice-items">
          <h3>Items</h3>
          <table>
            <thead>
              <tr>
                <th>Description</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody id="modal-items">
              <!-- Invoice items will be populated here -->
            </tbody>
          </table>
        </div>
        
        <div class="invoice-total">
          <p>Total: <span id="modal-total"></span></p>
        </div>
        
        <div id="payment-section" class="payment-section">
          <h3>Payment Options</h3>
          <div id="paypal-button" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="loading-spinner">
    <div class="spinner"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Toggle platforms submenu when clicking on Platforms
      const platformsLink = document.getElementById('platforms-link');
      const platformsSubmenu = document.querySelector('#platforms-link + .submenu');
      const containerSubmenu = document.querySelector('#containers-link + .submenu');
      
      if (platformsLink && platformsSubmenu) {
        platformsLink.addEventListener('click', function(e) {
          e.preventDefault();
          const isVisible = platformsSubmenu.style.display === 'block';
          platformsSubmenu.style.display = isVisible ? 'none' : 'block';
          
          // Hide other submenus when opening this one
          if (!isVisible && containerSubmenu) {
            containerSubmenu.style.display = 'none';
          }
        });
      }
      
      // Handle containers submenu toggle
      const containersLink = document.getElementById('containers-link');
      if (containersLink && containerSubmenu) {
        containersLink.addEventListener('click', function(e) {
          e.preventDefault();
          const isVisible = containerSubmenu.style.display === 'block';
          containerSubmenu.style.display = isVisible ? 'none' : 'block';
          
          // Hide other submenus when opening this one
          if (!isVisible && platformsSubmenu) {
            platformsSubmenu.style.display = 'none';
          }
        });
      }
      // Check if WebSocket is supported
      if ('WebSocket' in window) {
        connectWebSocket();
      }
      
      // Initialize page
      loadInvoices();
      populateContainerFilter();
      
      // Add event listeners
      document.getElementById('filter-button').addEventListener('click', loadInvoices);
      
      // Modal close button
      const closeModalBtn = document.querySelector('.close');
      closeModalBtn.addEventListener('click', function() {
        document.getElementById('invoice-modal').style.display = 'none';
      });
      
      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const modal = document.getElementById('invoice-modal');
        if (event.target === modal) {
          modal.style.display = 'none';
        }
      });
      
      // Get container ID from URL query parameter (if any)
      const urlParams = new URLSearchParams(window.location.search);
      const containerIdParam = urlParams.get('container');
      if (containerIdParam) {
        document.getElementById('container-filter').value = containerIdParam;
        loadInvoices();
      }
    });
    
    // WebSocket connection
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      const socket = new WebSocket(wsUrl);
      
      socket.onopen = function() {
        console.log('WebSocket connection established');
        
        // Subscribe to invoice updates
        socket.send(JSON.stringify({
          type: 'subscribe',
          channel: 'invoices'
        }));
      };
      
      socket.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('WebSocket message received:', data);
          
          // Handle different message types
          if (data.type === 'per-diem-update') {
            // Refresh invoices when new per diem charges are processed
            loadInvoices();
            // Show notification
            alert(`Invoice Update: ${data.message}`);
          }
        } catch (error) {
          console.error('Error handling WebSocket message:', error);
        }
      };
      
      socket.onclose = function() {
        console.log('WebSocket connection closed');
        // Try to reconnect after 5 seconds
        setTimeout(connectWebSocket, 5000);
      };
      
      socket.onerror = function(error) {
        console.error('WebSocket error:', error);
      };
    }
    
    // Load invoices from the server
    function loadInvoices(page = 1) {
      document.getElementById('loading-spinner').style.display = 'flex';
      
      // Get filter values
      const status = document.getElementById('status-filter').value;
      const containerId = document.getElementById('container-filter').value;
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;
      
      // Build query parameters
      const params = new URLSearchParams();
      params.append('page', page);
      if (status) params.append('status', status);
      if (containerId) params.append('containerId', containerId);
      if (dateFrom) params.append('dateFrom', dateFrom);
      if (dateTo) params.append('dateTo', dateTo);
      
      // Fetch invoices from API
      fetch(`/api/invoices?${params.toString()}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          displayInvoices(data.invoices);
          updateSummary(data.summary);
          setupPagination(data.pagination);
          document.getElementById('loading-spinner').style.display = 'none';
        })
        .catch(error => {
          console.error('Error fetching invoices:', error);
          document.getElementById('loading-spinner').style.display = 'none';
          
          // For testing/demo, generate sample invoices if API fails
          if (error) {
            const sampleData = generateSampleInvoices();
            displayInvoices(sampleData.invoices);
            updateSummary(sampleData.summary);
            setupPagination(sampleData.pagination);
          }
        });
    }
    
    // Populate container filter dropdown
    function populateContainerFilter() {
      fetch('/api/containers')
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          const containerSelect = document.getElementById('container-filter');
          
          // Clear existing options except the first one
          containerSelect.innerHTML = '<option value="">All Containers</option>';
          
          // Add container options
          data.forEach(container => {
            const option = document.createElement('option');
            option.value = container.id;
            option.textContent = `${container.id} (${container.origin} ‚Üí ${container.destination})`;
            containerSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error fetching containers:', error);
          
          // For testing/demo, add sample containers if API fails
          const sampleContainers = [
            { id: 'CONT-001', origin: 'Bangkok', destination: 'Los Angeles, CA' },
            { id: 'CONT-002', origin: 'Shanghai', destination: 'New York, NY' },
            { id: 'CONT-003', origin: 'Rotterdam', destination: 'Miami, FL' },
            { id: 'CONT-004', origin: 'Hong Kong', destination: 'Seattle, WA' }
          ];
          
          const containerSelect = document.getElementById('container-filter');
          containerSelect.innerHTML = '<option value="">All Containers</option>';
          
          sampleContainers.forEach(container => {
            const option = document.createElement('option');
            option.value = container.id;
            option.textContent = `${container.id} (${container.origin} ‚Üí ${container.destination})`;
            containerSelect.appendChild(option);
          });
        });
    }
    
    // Display invoices in the table
    function displayInvoices(invoices) {
      const tableBody = document.getElementById('invoices-list');
      const emptyState = document.getElementById('empty-state');
      
      // Clear existing rows
      tableBody.innerHTML = '';
      
      if (invoices.length === 0) {
        // Show empty state
        document.getElementById('invoices-table').style.display = 'none';
        emptyState.style.display = 'block';
      } else {
        // Hide empty state and show table
        document.getElementById('invoices-table').style.display = 'table';
        emptyState.style.display = 'none';
        
        // Add invoices to table
        invoices.forEach(invoice => {
          const row = document.createElement('tr');
          
          // Format dates
          const invoiceDate = new Date(invoice.date).toLocaleDateString();
          const dueDate = new Date(invoice.dueDate).toLocaleDateString();
          
          // Create status pill
          const statusPill = `<span class="status-pill status-${invoice.status.toLowerCase()}">${invoice.status}</span>`;
          
          // Create action buttons
          const actionButtons = `
            <div class="action-buttons">
              <button class="btn btn-primary view-invoice" data-id="${invoice.id}">View</button>
              ${invoice.status === 'pending' ? `<button class="btn btn-success pay-invoice" data-id="${invoice.id}">Pay</button>` : ''}
            </div>
          `;
          
          row.innerHTML = `
            <td>${invoice.id}</td>
            <td>${invoice.containerId}</td>
            <td>${invoiceDate}</td>
            <td>${dueDate}</td>
            <td>$${invoice.amount.toFixed(2)}</td>
            <td>${statusPill}</td>
            <td>${actionButtons}</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        // Add event listeners to view buttons
        document.querySelectorAll('.view-invoice').forEach(button => {
          button.addEventListener('click', function() {
            const invoiceId = this.getAttribute('data-id');
            viewInvoiceDetails(invoiceId);
          });
        });
        
        // Add event listeners to pay buttons
        document.querySelectorAll('.pay-invoice').forEach(button => {
          button.addEventListener('click', function() {
            const invoiceId = this.getAttribute('data-id');
            viewInvoiceDetails(invoiceId, true);
          });
        });
      }
    }
    
    // Update summary cards
    function updateSummary(summary) {
      document.getElementById('total-invoices-count').textContent = summary.total;
      document.getElementById('paid-invoices-count').textContent = summary.paid;
      document.getElementById('pending-invoices-count').textContent = summary.pending;
      document.getElementById('overdue-invoices-count').textContent = summary.overdue;
      document.getElementById('total-amount').textContent = `$${summary.totalAmount.toFixed(2)}`;
    }
    
    // Setup pagination
    function setupPagination(pagination) {
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = '';
      
      // Only show pagination if there's more than one page
      if (pagination.totalPages <= 1) {
        return;
      }
      
      // Add 'Previous' button
      if (pagination.currentPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.addEventListener('click', function() {
          loadInvoices(pagination.currentPage - 1);
        });
        paginationContainer.appendChild(prevButton);
      }
      
      // Add page number buttons
      for (let i = 1; i <= pagination.totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        pageButton.classList.toggle('active', i === pagination.currentPage);
        pageButton.addEventListener('click', function() {
          loadInvoices(i);
        });
        paginationContainer.appendChild(pageButton);
      }
      
      // Add 'Next' button
      if (pagination.currentPage < pagination.totalPages) {
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.addEventListener('click', function() {
          loadInvoices(pagination.currentPage + 1);
        });
        paginationContainer.appendChild(nextButton);
      }
    }
    
    // View invoice details in modal
    function viewInvoiceDetails(invoiceId, showPayment = false) {
      document.getElementById('loading-spinner').style.display = 'flex';
      
      // Fetch invoice details from API
      fetch(`/api/invoices/${invoiceId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(invoice => {
          populateInvoiceModal(invoice, showPayment);
          document.getElementById('loading-spinner').style.display = 'none';
        })
        .catch(error => {
          console.error('Error fetching invoice details:', error);
          document.getElementById('loading-spinner').style.display = 'none';
          
          // For testing/demo, generate a sample invoice if API fails
          if (error) {
            const sampleInvoice = generateSampleInvoiceDetails(invoiceId);
            populateInvoiceModal(sampleInvoice, showPayment);
          }
        });
    }
    
    // Populate invoice modal with details
    function populateInvoiceModal(invoice, showPayment) {
      // Set invoice details
      document.getElementById('modal-invoice-number').textContent = invoice.id;
      document.getElementById('modal-container-id').textContent = invoice.containerId;
      document.getElementById('modal-invoice-date').textContent = new Date(invoice.date).toLocaleDateString();
      document.getElementById('modal-due-date').textContent = new Date(invoice.dueDate).toLocaleDateString();
      
      // Set status with appropriate styling
      const statusElement = document.getElementById('modal-status');
      statusElement.textContent = invoice.status;
      statusElement.className = `status-pill status-${invoice.status.toLowerCase()}`;
      
      // Populate items table
      const itemsContainer = document.getElementById('modal-items');
      itemsContainer.innerHTML = '';
      
      invoice.items.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.description}</td>
          <td>${item.quantity}</td>
          <td>$${item.price.toFixed(2)}</td>
          <td>$${item.total.toFixed(2)}</td>
        `;
        itemsContainer.appendChild(row);
      });
      
      // Set total
      document.getElementById('modal-total').textContent = `$${invoice.amount.toFixed(2)}`;
      
      // Show/hide payment section based on invoice status and showPayment flag
      const paymentSection = document.getElementById('payment-section');
      if (invoice.status === 'pending' && showPayment) {
        paymentSection.style.display = 'block';
        initializePayPalButton(invoice);
      } else {
        paymentSection.style.display = 'none';
      }
      
      // Show the modal
      document.getElementById('invoice-modal').style.display = 'block';
    }
    
    // Initialize PayPal button for invoice payment
    function initializePayPalButton(invoice) {
      const paypalButtonContainer = document.getElementById('paypal-button');
      paypalButtonContainer.innerHTML = '';
      
      // Create custom PayPal button
      const payButton = document.createElement('button');
      payButton.className = 'btn btn-primary';
      payButton.textContent = `Pay $${invoice.amount.toFixed(2)} with PayPal`;
      payButton.style.width = '100%';
      payButton.style.padding = '10px';
      
      payButton.addEventListener('click', function() {
        document.getElementById('loading-spinner').style.display = 'flex';
        
        // Call PayPal API to create order
        fetch('/paypal/order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            intent: 'CAPTURE',
            amount: invoice.amount.toString(),
            currency: 'USD'
          })
        })
          .then(response => response.json())
          .then(data => {
            // Redirect to PayPal checkout
            window.location.href = data.links.find(link => link.rel === 'approve').href;
          })
          .catch(error => {
            console.error('Error creating PayPal order:', error);
            document.getElementById('loading-spinner').style.display = 'none';
            alert('There was an error processing your payment. Please try again later.');
          });
      });
      
      paypalButtonContainer.appendChild(payButton);
    }
    
    // For testing/demo purposes only: Generate sample invoices
    function generateSampleInvoices() {
      const invoices = [];
      const statuses = ['pending', 'paid', 'overdue', 'cancelled'];
      const containers = ['CONT-001', 'CONT-002', 'CONT-003', 'CONT-004'];
      
      for (let i = 1; i <= 10; i++) {
        const date = new Date();
        date.setDate(date.getDate() - Math.floor(Math.random() * 30));
        
        const dueDate = new Date(date);
        dueDate.setDate(date.getDate() + 14);
        
        const status = statuses[Math.floor(Math.random() * statuses.length)];
        const amount = (Math.random() * 100 + 10).toFixed(2);
        
        invoices.push({
          id: `INV-${1000 + i}`,
          containerId: containers[Math.floor(Math.random() * containers.length)],
          date: date.toISOString(),
          dueDate: dueDate.toISOString(),
          amount: parseFloat(amount),
          status: status
        });
      }
      
      return {
        invoices: invoices,
        summary: {
          total: invoices.length,
          paid: invoices.filter(i => i.status === 'paid').length,
          pending: invoices.filter(i => i.status === 'pending').length,
          overdue: invoices.filter(i => i.status === 'overdue').length,
          totalAmount: invoices.reduce((sum, invoice) => sum + invoice.amount, 0)
        },
        pagination: {
          currentPage: 1,
          totalPages: 2,
          itemsPerPage: 10,
          totalItems: 15
        }
      };
    }
    
    // For testing/demo purposes only: Generate sample invoice details
    function generateSampleInvoiceDetails(invoiceId) {
      const date = new Date();
      date.setDate(date.getDate() - Math.floor(Math.random() * 30));
      
      const dueDate = new Date(date);
      dueDate.setDate(date.getDate() + 14);
      
      const perDiemRate = (Math.random() * 10 + 5).toFixed(2);
      const days = Math.floor(Math.random() * 5) + 1;
      const total = (parseFloat(perDiemRate) * days).toFixed(2);
      
      return {
        id: invoiceId,
        containerId: 'CONT-00' + Math.floor(Math.random() * 4 + 1),
        date: date.toISOString(),
        dueDate: dueDate.toISOString(),
        amount: parseFloat(total),
        status: Math.random() > 0.5 ? 'pending' : 'paid',
        items: [
          {
            description: `Per diem charge - Day ${days}`,
            quantity: 1,
            price: parseFloat(perDiemRate),
            total: parseFloat(total)
          }
        ]
      };
    }
    
    // Containers dropdown functionality
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('containers-link').addEventListener('click', function(e) {
        e.preventDefault();
        const submenu = this.nextElementSibling;
        if (submenu.style.display === 'block') {
          submenu.style.display = 'none';
        } else {
          submenu.style.display = 'block';
        }
      });
      
      // Add Container and View Container links functionality
      document.getElementById('add-container-link').addEventListener('click', function(e) {
        e.preventDefault();
        // In a real app, this would navigate to the Add Container page
        alert('Add Container functionality will be implemented in the next phase');
      });
    });
  </script>
</body>
</html>